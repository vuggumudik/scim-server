# scim-server

Basic implementation of SCIM 2.0 server using SKIMMY and SLIMMY-ROUTERS npm packages. It is still work in progress. It is implemented with multi-tenancy in mind.

 - Not all functionality is tested thoroughly at this point.
 - Features such as filtering, sorting are not fully supported and tested yet.

 - Unit tests are automatically generated by copilot, not fully functional. Needs some tweaking.

 - Just for testing purposes, data is getting writting to sqlite3 database. 

 - All the async methods in class Repository that are in repo/sqliteRepo.js should be implemented to fit to your own needs. If a new repository is implemented, update line `const repository = new Repository();` in server.js with your own implementation.

 - Authentication should be handled in `authService.js` file.

 ## TODO:
- Lots of testing and code cleanup needs to be done.
- Need to fix the error handling.
- Need to fix unit test cases.
- Need to implement and test filtering and sorting.

## Running
`node server.js`

## Testing
### User Operations
- Create a User
```
curl --location 'http://localhost:3000/scim/v2/Users' \
--header 'Authorization: Bearer test' \
--header 'Content-Type: application/scim+json' \
--data-raw '{
    "schemas": [
        "urn:ietf:params:scim:schemas:core:2.0:User",
        "urn:ietf:params:scim:schemas:extension:enterprise:2.0:User"
    ],
    "userName": "john.doe@test.com",
    "externalId": "12345",
    "name": {
        "givenName": "John",
        "familyName": "Doe"
    },
    "emails": [
        {
            "value": "jdoe@test.com",
            "type": "work",
            "primary": true
        }
    ],
    "active": true,
    "urn:ietf:params:scim:schemas:extension:enterprise:2.0:User": {
    "employeeNumber": "1",
    "costCenter": "1",
    "organization": "XYZ Inc",
    "division": "Engineering",
    "department": "IT"
  }
}' 
```

- Update User

```
curl --location --request PUT 'http://localhost:3000/scim/v2/Users/{id}' \
--header 'Authorization: Bearer test' \
--header 'Content-Type: application/scim+json' \
--data-raw '{
    "schemas": [
        "urn:ietf:params:scim:schemas:core:2.0:User",
        "urn:ietf:params:scim:schemas:extension:enterprise:2.0:User"
    ],
    "id": "9cdf3d89-912f-4145-b348-0e35b97a89de",
    "meta": {
        "resourceType": "User",
        "location": "/scim/v2/Users/9cdf3d89-912f-4145-b348-0e35b97a89de"
    },
    "userName": "john.doe@test.com",
    "name": {
        "familyName": "Doe",
        "givenName": "Updated"
    },
    "active": true,
    "emails": [
        {
            "value": "jdoe@test.com",
            "type": "work",
            "primary": true
        }
    ],
    "tenant": "test-tenant",
    "urn:ietf:params:scim:schemas:extension:enterprise:2.0:User": {
        "employeeNumber": "1",
        "costCenter": "1",
        "organization": "XYZ Inc",
        "division": "Engineering",
        "department": "IT"
    }
}'
```

- Patch User

```
curl --location --request PATCH 'http://localhost:3000/scim/v2/Users/{id}' \
--header 'Authorization: Bearer Test' \
--header 'Content-Type: application/scim+json' \
--data '{
    "schemas": [
        "urn:ietf:params:scim:api:messages:2.0:PatchOp"
    ],
    "id": "04933228-5582-47fa-b897-1624f551534b",
    "Operations": [
        {
            "op": "replace",
            "value": {
                "name": {
                    "givenName": "Patched John",
                    "familyName": "Doe"
                }
            }
        }
    ]
}'
```

- Get Users (No pagination support)

```
curl --location 'http://localhost:3000/scim/v2/Users/' \
--header 'Authorization: Bearer test' 
```

- Get User

```
curl --location 'http://localhost:3000/scim/v2/Users/{id}' \
--header 'Authorization: Bearer test' 
```

- Filter Users (no pagination support and also not all attributes are supported)

```
curl --location 'http://localhost:3000/scim/v2/Users?filter=userName%20eq%20%22ajohn.doe%40test.com%22&startIndex=1&count=100%27' \
--header 'Authorization: Bearer test' 
```

### Group Operations
-  Create Group
```
curl --location 'http://localhost:3000/scim/v2/Groups' \
--header 'Authorization: Bearer test' \
--header 'Content-Type: application/scim+json' \
--data '{
    "schemas": ["urn:ietf:params:scim:schemas:core:2.0:Group"],
    "displayName": "Test Group",
    "members": [
    ]
}
'
```

- Get Group
```
curl --location 'http://localhost:3000/scim/v2/Groups/{id}' \
--header 'Authorization: Bearer test'
```

- Get Groups
```
curl --location 'http://localhost:3000/scim/v2/Groups' \
--header 'Authorization: Bearer test'
```

- Patch Group
```
curl --location --request PATCH 'http://localhost:3000/scim/v2/Groups/{id}' \
--header 'Authorization: Bearer Test' \
--header 'Content-Type: application/scim+json' \
--data '{
    "schemas": ["urn:ietf:params:scim:api:messages:2.0:PatchOp"],
    "Operations": [{
        "op": "replace",
        "value": {
            "id": "3ef65fd1-7bc1-428f-9ae5-27b76d22fb75",
            "displayName": "Test Group 1"
        }
    }]
}'
```

- Patch Group (to modify group members)
```
curl --location --request PATCH 'http://localhost:3000/scim/v2/Groups/{id}' \
--header 'Authorization: Bearer Test' \
--header 'Content-Type: application/scim+json' \
--data '{
    "schemas": [
        "urn:ietf:params:scim:api:messages:2.0:PatchOp"
    ],
    "Operations": [
        {
            "op": "remove",
            "path": "members",
            "value": [
                {
                    "value": "a1438d91-70ae-47f1-8237-3fcaf7c6465b"
                }
            ]
        },
        {
            "op": "add",
            "path": "members",
            "value": [
                {
                    "value": "a1438d91-70ae-47f1-8237-3fcaf7c646sfsf"
                }
            ]
        }
    ]
}'
```





 
